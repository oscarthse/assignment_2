name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff black
    
    - name: Check code formatting with Black
      run: |
        black --check src/ || (echo "Code is not formatted. Run 'black src/' to fix." && exit 1)
    
    - name: Lint with Ruff
      run: |
        ruff check src/ --output-format=github
    
    - name: Validate Python syntax
      run: |
        python -m py_compile src/*.py || exit 1

  validate-structure:
    name: Project Structure Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate required files exist
      run: |
        required_files=(
          "src/model.py"
          "src/data_prep.py"
          "src/features.py"
          "src/evaluate.py"
          "src/utils.py"
          "requirements.txt"
          "README.md"
          "pyproject.toml"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "❌ Missing required files:"
          printf '  - %s\n' "${missing_files[@]}"
          exit 1
        else
          echo "✅ All required files exist"
        fi

  import-validation:
    name: Import and Syntax Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate imports (graceful)
      run: |
        # Try to import modules, but don't fail if they're empty
        python -c "
        import sys
        errors = []
        
        modules = [
            'src.data_prep',
            'src.features', 
            'src.model',
            'src.evaluate',
            'src.utils'
        ]
        
        for module in modules:
            try:
                __import__(module)
                print(f'✅ {module} imports successfully')
            except SyntaxError as e:
                errors.append(f'{module}: SyntaxError - {e}')
                print(f'❌ {module}: Syntax error')
            except ImportError as e:
                # Only fail on actual import errors, not missing dependencies
                if 'No module named' in str(e) and 'src' not in str(e):
                    errors.append(f'{module}: ImportError - {e}')
                    print(f'❌ {module}: Import error')
                else:
                    print(f'⚠️  {module}: {e} (may be expected if file is empty)')
            except Exception as e:
                print(f'⚠️  {module}: {e} (may be expected if file is empty)')
        
        if errors:
            print('\\nErrors found:')
            for err in errors:
                print(f'  - {err}')
            sys.exit(1)
        else:
            print('\\n✅ All modules have valid syntax')
        "

  dependency-check:
    name: Dependency Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate requirements.txt format
      run: |
        # Check that requirements.txt exists and is readable
        if [ ! -f requirements.txt ]; then
          echo "❌ requirements.txt not found"
          exit 1
        fi
        
        # Check for common formatting issues
        if grep -q '^"' requirements.txt || grep -q '^'"'" requirements.txt; then
          echo "❌ requirements.txt contains quoted packages (should be unquoted)"
          exit 1
        fi
        
        # Check that each line is a valid package spec
        python -c "
        import re
        with open('requirements.txt', 'r') as f:
            lines = [l.strip() for l in f if l.strip() and not l.startswith('#')]
        
        for line in lines:
            # Allow: package, package==version, package>=version, package<=version, package~=version
            if not re.match(r'^[a-zA-Z0-9_-]+(\[[^\]]+\])?([<>=!~]+[0-9.]+)?$', line):
                print(f'❌ Invalid requirement format: {line}')
                exit(1)
        
        print('✅ requirements.txt format is valid')
        "
        
        echo "✅ requirements.txt validation passed"

